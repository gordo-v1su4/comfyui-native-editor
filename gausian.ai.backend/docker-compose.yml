# docker-compose.yml
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      # Persist Postgres data
      - db-data:/var/lib/postgresql/data
      # Optional: run .sql files once on a brand-new data dir
      - ./db/init:/docker-entrypoint-initdb.d:ro
    init: true
    restart: unless-stopped

  backend:
    build:
      context: ./api
      dockerfile: Dockerfile
    init: true                  # service-level init
    stop_signal: SIGKILL
    stop_grace_period: 0s
    restart: "no"
    environment:
      DATABASE_URL: postgres://app:app@db:5432/app
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGINS: "http://localhost:5173,https://*.vercel.app,https://*.trycloudflare.com"
      # Modal auth (provide via host env or .env file)
      MODAL_TOKEN_ID: ${MODAL_TOKEN_ID}
      MODAL_TOKEN_SECRET: ${MODAL_TOKEN_SECRET}
      # Point Modal deploy at the file that exists inside the image
      MODAL_DEPLOY_CMD: modal deploy /app/comfy-modal/headless_comfyui.py
      DEBUG_PROMPT: "1"
      
      # Public backend URL passed through to the Modal app for upload callbacks
      # Prefer environment-provided value (e.g., from CI/hosting). Fallback to current Cloudflare tunnel.
      # If your deployment system (e.g., Vercel) injects env vars, set BACKEND_URL there.
      BACKEND_URL: ${BACKEND_URL:-https://iso-seventh-closely-feeding.trycloudflare.com}
      
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      S3_BUCKET: ${S3_BUCKET}
      S3_REGION: ${S3_REGION}
      S3_ENDPOINT: ${S3_ENDPOINT}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "127.0.0.1:3001:3001"
    volumes:
      - ./api/comfy-modal:/app/comfy-modal:ro

volumes:
  db-data:
